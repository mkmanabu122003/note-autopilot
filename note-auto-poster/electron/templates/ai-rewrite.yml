name: AI Rewrite

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  rewrite:
    # Only run on PR comments starting with /rewrite
    if: >
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/rewrite')
    runs-on: ubuntu-latest

    steps:
      - name: Check rate limit
        id: rate-check
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const today = new Date().toISOString().split('T')[0];
            const rewriteCount = comments.data.filter(c =>
              c.body.startsWith('/rewrite') &&
              c.created_at.startsWith(today) &&
              c.user.login === context.actor
            ).length;
            if (rewriteCount > 20) {
              core.setFailed('1æ—¥ã‚ãŸã‚Šã®ãƒªãƒ©ã‚¤ãƒˆä¸Šé™ï¼ˆ20å›ï¼‰ã«é”ã—ã¾ã—ãŸ');
              return;
            }
            core.setOutput('count', rewriteCount);

      - name: Check write permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor,
            });
            if (!['admin', 'write'].includes(perm.permission)) {
              core.setFailed('ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
            }

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('branch', pr.head.ref);
            core.setOutput('sha', pr.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.branch }}
          fetch-depth: 0

      - name: Ensure scripts are available from main
        run: |
          if [ ! -f .github/scripts/rewrite-parser.js ] || [ ! -f .github/scripts/rewrite.js ]; then
            echo "Scripts not found on PR branch, copying from main..."
            git checkout origin/main -- .github/scripts/ 2>/dev/null || echo "::warning::Scripts not found on main branch either. Run setupWorkflow from the app."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk@latest js-yaml@latest

      - name: Parse rewrite command
        id: parse
        run: |
          node .github/scripts/rewrite-parser.js '${{ github.event.comment.body }}' '${{ steps.pr-details.outputs.branch }}'

      - name: Collect review comments for batch apply
        id: batch-collect
        if: steps.parse.outputs.action == 'apply'
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch all review comments on this PR
            const allComments = await github.paginate(
              github.rest.pulls.listReviewComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              }
            );

            // Find /rewrite comments that haven't been processed yet
            // (processed ones have a bot reply starting with âœ…)
            const rewriteComments = [];
            for (const c of allComments) {
              if (!c.body.trim().startsWith('/rewrite')) continue;

              // Check if this comment has already been processed by looking for bot reply
              const replies = allComments.filter(r =>
                r.in_reply_to_id === c.id &&
                r.user.login === 'github-actions[bot]' &&
                r.body.startsWith('âœ…')
              );
              if (replies.length > 0) continue;

              const instruction = c.body.trim().slice('/rewrite'.length).trim() || 'æ”¹å–„ã—ã¦ãã ã•ã„';
              const startLine = c.start_line || c.original_start_line || c.line || c.original_line;
              const endLine = c.line || c.original_line;

              rewriteComments.push({
                id: c.id,
                file: c.path,
                lineStart: startLine,
                lineEnd: endLine,
                instruction: instruction,
              });
            }

            if (rewriteComments.length === 0) {
              core.setFailed('å‡¦ç†å¯¾è±¡ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Files changedã‚¿ãƒ–ã§ /rewrite ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            const fs = require('fs');
            fs.writeFileSync('/tmp/batch-edits.json', JSON.stringify(rewriteComments, null, 2));
            core.setOutput('count', String(rewriteComments.length));
            core.setOutput('comment_ids', rewriteComments.map(c => c.id).join(','));
            console.log(`${rewriteComments.length} ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’åé›†ã—ã¾ã—ãŸ`);
            for (const c of rewriteComments) {
              console.log(`  - ${c.file}:${c.lineStart}-${c.lineEnd} "${c.instruction}"`);
            }

      - name: Execute batch rewrite
        id: batch-rewrite
        if: steps.parse.outputs.action == 'apply'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BATCH_FILE: /tmp/batch-edits.json
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          node .github/scripts/rewrite.js

      - name: Execute single rewrite
        id: rewrite
        if: steps.parse.outputs.action == 'rewrite'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_FILE: ${{ steps.parse.outputs.target_file }}
          LINE_START: ${{ steps.parse.outputs.line_start }}
          LINE_END: ${{ steps.parse.outputs.line_end }}
          QUOTE_TEXT: ${{ steps.parse.outputs.quote_text }}
          INSTRUCTION: ${{ steps.parse.outputs.instruction }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          node .github/scripts/rewrite.js

      - name: Execute undo
        id: undo
        if: steps.parse.outputs.action == 'undo'
        run: |
          LAST_REWRITE=$(git log --oneline --grep='\[rewrite\]' -1 --format="%H")
          if [ -z "$LAST_REWRITE" ]; then
            echo "error=ãƒªãƒ©ã‚¤ãƒˆã‚³ãƒŸãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_OUTPUT
          else
            git revert --no-edit "$LAST_REWRITE"
            git push origin ${{ steps.pr-details.outputs.branch }}
            echo "reverted=$LAST_REWRITE" >> $GITHUB_OUTPUT
          fi

      - name: Execute diff preview
        id: diff-preview
        if: steps.parse.outputs.action == 'diff'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_FILE: ${{ steps.parse.outputs.target_file }}
          LINE_START: ${{ steps.parse.outputs.line_start }}
          LINE_END: ${{ steps.parse.outputs.line_end }}
          QUOTE_TEXT: ${{ steps.parse.outputs.quote_text }}
          INSTRUCTION: ${{ steps.parse.outputs.instruction }}
          DRY_RUN: "true"
        run: |
          node .github/scripts/rewrite.js

      - name: Commit and push
        id: commit
        if: >
          (steps.parse.outputs.action == 'rewrite' && steps.rewrite.outputs.success == 'true') ||
          (steps.parse.outputs.action == 'apply' && steps.batch-rewrite.outputs.success == 'true')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if [ "${{ steps.parse.outputs.action }}" = "apply" ]; then
            COMMIT_MSG="[rewrite] ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ ${{ steps.batch-collect.outputs.count }}ä»¶ã‚’ä¸€æ‹¬ãƒªãƒ©ã‚¤ãƒˆ"
          else
            INSTRUCTION="${{ steps.parse.outputs.instruction }}"
            COMMIT_MSG="[rewrite] ${INSTRUCTION:0:30}"
          fi
          git commit -m "$COMMIT_MSG"
          git push origin ${{ steps.pr-details.outputs.branch }}

      - name: Comment single rewrite result
        if: steps.parse.outputs.action == 'rewrite' && steps.rewrite.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('/tmp/rewrite-summary.md', 'utf-8');
            } catch {
              summary = 'ãƒªãƒ©ã‚¤ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… ãƒªãƒ©ã‚¤ãƒˆå®Œäº†\n\n${summary}`,
            });

      - name: Comment batch apply result and reply to review comments
        if: steps.parse.outputs.action == 'apply' && steps.batch-rewrite.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const success = '${{ steps.batch-rewrite.outputs.success }}' === 'true';

            // Reply to each review comment
            const commentIds = '${{ steps.batch-collect.outputs.comment_ids }}'.split(',');
            if (success) {
              for (const id of commentIds) {
                try {
                  await github.rest.pulls.createReplyForReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    comment_id: parseInt(id),
                    body: 'âœ… ãƒªãƒ©ã‚¤ãƒˆé©ç”¨æ¸ˆã¿',
                  });
                } catch (e) {
                  console.log(`Failed to reply to comment ${id}: ${e.message}`);
                }
              }
            }

            // Post summary to PR conversation
            let summary = '';
            try {
              summary = fs.readFileSync('/tmp/rewrite-summary.md', 'utf-8');
            } catch {
              summary = success ? 'ãƒªãƒ©ã‚¤ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚' : 'ãƒªãƒ©ã‚¤ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            const emoji = success ? 'âœ…' : 'âš ï¸';
            const label = success ? 'ä¸€æ‹¬ãƒªãƒ©ã‚¤ãƒˆå®Œäº†' : 'ä¸€æ‹¬ãƒªãƒ©ã‚¤ãƒˆå¤±æ•—';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${emoji} ${label}ï¼ˆ${commentIds.length}ä»¶ï¼‰\n\n${summary}`,
            });

      - name: Comment undo result
        if: steps.parse.outputs.action == 'undo'
        uses: actions/github-script@v7
        with:
          script: |
            const reverted = '${{ steps.undo.outputs.reverted }}';
            const error = '${{ steps.undo.outputs.error }}';
            if (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ Undo å¤±æ•—: ${error}`,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `â†©ï¸ ç›´å‰ã®ãƒªãƒ©ã‚¤ãƒˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸï¼ˆ${reverted.substring(0, 7)}ï¼‰`,
              });
            }

      - name: Comment diff preview
        if: steps.parse.outputs.action == 'diff' && steps.diff-preview.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let diff = '';
            try {
              diff = fs.readFileSync('/tmp/rewrite-diff.md', 'utf-8');
            } catch {
              diff = 'å·®åˆ†ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ“ ãƒªãƒ©ã‚¤ãƒˆå·®åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚³ãƒŸãƒƒãƒˆãªã—ï¼‰\n\n${diff}`,
            });

      - name: Comment on error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âŒ ãƒªãƒ©ã‚¤ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                '',
                '### ä½¿ã„æ–¹',
                '```',
                '/rewrite [æŒ‡ç¤ºå†…å®¹]              - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ©ã‚¤ãƒˆ',
                '/rewrite ãƒ•ã‚¡ã‚¤ãƒ«å.md [æŒ‡ç¤ºå†…å®¹] - ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ©ã‚¤ãƒˆ',
                '/rewrite L10-L25 [æŒ‡ç¤ºå†…å®¹]       - è¡Œç¯„å›²ã‚’ãƒªãƒ©ã‚¤ãƒˆ',
                '/rewrite ã€Œå¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆã€[æŒ‡ç¤º]    - å¼•ç”¨ç®‡æ‰€ã‚’ãƒªãƒ©ã‚¤ãƒˆ',
                '/rewrite apply                   - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ‹¬é©ç”¨',
                '/rewrite undo                    - ç›´å‰ã®ãƒªãƒ©ã‚¤ãƒˆã‚’å–ã‚Šæ¶ˆã—',
                '/rewrite diff [æŒ‡ç¤ºå†…å®¹]          - å·®åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                '```',
                '',
                '### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã§éƒ¨åˆ†ãƒªãƒ©ã‚¤ãƒˆ',
                '1. Files changed ã‚¿ãƒ–ã§ç·¨é›†ã—ãŸã„è¡Œã‚’é¸æŠ',
                '2. `/rewrite [æŒ‡ç¤º]` ã¨ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè¤‡æ•°ç®‡æ‰€OKï¼‰',
                '3. Conversation ã‚¿ãƒ–ã§ `/rewrite apply` ã¨å…¥åŠ›',
              ].join('\n'),
            });
