name: AI Rewrite

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  rewrite-from-pr-comment:
    # PR conversation tab comments starting with /rewrite
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/rewrite')
    runs-on: ubuntu-latest

    steps:
      - name: Check rate limit
        id: rate-check
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const today = new Date().toISOString().split('T')[0];
            const rewriteCount = comments.data.filter(c =>
              c.body.startsWith('/rewrite') &&
              c.created_at.startsWith(today) &&
              c.user.login === context.actor
            ).length;
            if (rewriteCount > 20) {
              core.setFailed('1æ—¥ã‚ãŸã‚Šã®ãƒªãƒ©ã‚¤ãƒˆä¸Šé™ï¼ˆ20å›ï¼‰ã«é”ã—ã¾ã—ãŸ');
              return;
            }
            core.setOutput('count', rewriteCount);

      - name: Check write permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor,
            });
            if (!['admin', 'write'].includes(perm.permission)) {
              core.setFailed('ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
            }

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('branch', pr.head.ref);
            core.setOutput('sha', pr.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk@latest js-yaml@latest

      - name: Parse rewrite command
        id: parse
        run: |
          node .github/scripts/rewrite-parser.js '${{ github.event.comment.body }}' '${{ steps.pr-details.outputs.branch }}'

      - name: Execute rewrite
        id: rewrite
        if: steps.parse.outputs.action == 'rewrite'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_FILE: ${{ steps.parse.outputs.target_file }}
          LINE_START: ${{ steps.parse.outputs.line_start }}
          LINE_END: ${{ steps.parse.outputs.line_end }}
          QUOTE_TEXT: ${{ steps.parse.outputs.quote_text }}
          INSTRUCTION: ${{ steps.parse.outputs.instruction }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          node .github/scripts/rewrite.js

      - name: Execute undo
        id: undo
        if: steps.parse.outputs.action == 'undo'
        run: |
          LAST_REWRITE=$(git log --oneline --grep='\[rewrite\]' -1 --format="%H")
          if [ -z "$LAST_REWRITE" ]; then
            echo "error=ãƒªãƒ©ã‚¤ãƒˆã‚³ãƒŸãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_OUTPUT
          else
            git revert --no-edit "$LAST_REWRITE"
            git push origin ${{ steps.pr-details.outputs.branch }}
            echo "reverted=$LAST_REWRITE" >> $GITHUB_OUTPUT
          fi

      - name: Execute diff preview
        id: diff-preview
        if: steps.parse.outputs.action == 'diff'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_FILE: ${{ steps.parse.outputs.target_file }}
          LINE_START: ${{ steps.parse.outputs.line_start }}
          LINE_END: ${{ steps.parse.outputs.line_end }}
          QUOTE_TEXT: ${{ steps.parse.outputs.quote_text }}
          INSTRUCTION: ${{ steps.parse.outputs.instruction }}
          DRY_RUN: "true"
        run: |
          node .github/scripts/rewrite.js

      - name: Commit rewrite result
        if: steps.parse.outputs.action == 'rewrite' && steps.rewrite.outputs.success == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          INSTRUCTION="${{ steps.parse.outputs.instruction }}"
          SHORT_INSTRUCTION="${INSTRUCTION:0:30}"
          git commit -m "[rewrite] ${SHORT_INSTRUCTION}"
          git push origin ${{ steps.pr-details.outputs.branch }}

      - name: Comment rewrite result
        if: steps.parse.outputs.action == 'rewrite' && steps.rewrite.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('/tmp/rewrite-summary.md', 'utf-8');
            } catch {
              summary = 'ãƒªãƒ©ã‚¤ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… ãƒªãƒ©ã‚¤ãƒˆå®Œäº†\n\n${summary}`,
            });

      - name: Comment undo result
        if: steps.parse.outputs.action == 'undo'
        uses: actions/github-script@v7
        with:
          script: |
            const reverted = '${{ steps.undo.outputs.reverted }}';
            const error = '${{ steps.undo.outputs.error }}';
            if (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ Undo å¤±æ•—: ${error}`,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `â†©ï¸ ç›´å‰ã®ãƒªãƒ©ã‚¤ãƒˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸï¼ˆ${reverted.substring(0, 7)}ï¼‰`,
              });
            }

      - name: Comment diff preview
        if: steps.parse.outputs.action == 'diff' && steps.diff-preview.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let diff = '';
            try {
              diff = fs.readFileSync('/tmp/rewrite-diff.md', 'utf-8');
            } catch {
              diff = 'å·®åˆ†ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ“ ãƒªãƒ©ã‚¤ãƒˆå·®åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚³ãƒŸãƒƒãƒˆãªã—ï¼‰\n\n${diff}`,
            });

      - name: Comment on error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âŒ ãƒªãƒ©ã‚¤ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                '',
                '### ä½¿ã„æ–¹',
                '```',
                '/rewrite [æŒ‡ç¤ºå†…å®¹]',
                '/rewrite ãƒ•ã‚¡ã‚¤ãƒ«å.md [æŒ‡ç¤ºå†…å®¹]',
                '/rewrite L10-L25 [æŒ‡ç¤ºå†…å®¹]',
                '/rewrite ã€Œå¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆã€[æŒ‡ç¤ºå†…å®¹]',
                '/rewrite undo',
                '/rewrite diff [æŒ‡ç¤ºå†…å®¹]',
                '```',
              ].join('\n'),
            });

  rewrite-from-review-comment:
    # Line-specific review comments on Files changed tab
    if: >
      github.event_name == 'pull_request_review_comment' &&
      startsWith(github.event.comment.body, '/rewrite')
    runs-on: ubuntu-latest

    steps:
      - name: Check write permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor,
            });
            if (!['admin', 'write'].includes(perm.permission)) {
              core.setFailed('ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
            }

      - name: Extract review comment context
        id: review-context
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const pr = context.payload.pull_request;
            core.setOutput('branch', pr.head.ref);
            core.setOutput('file_path', comment.path);
            // For multi-line comments: start_line..line, for single-line: just line
            const startLine = comment.start_line || comment.original_start_line || comment.line || comment.original_line;
            const endLine = comment.line || comment.original_line;
            core.setOutput('line_start', String(startLine));
            core.setOutput('line_end', String(endLine));
            core.setOutput('pr_number', String(pr.number));
            // Extract instruction (everything after /rewrite)
            const body = comment.body.trim();
            const instruction = body.slice('/rewrite'.length).trim() || 'æ”¹å–„ã—ã¦ãã ã•ã„';
            core.setOutput('instruction', instruction);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.review-context.outputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk@latest js-yaml@latest

      - name: Execute rewrite on reviewed lines
        id: rewrite
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_FILE: ${{ steps.review-context.outputs.file_path }}
          LINE_START: ${{ steps.review-context.outputs.line_start }}
          LINE_END: ${{ steps.review-context.outputs.line_end }}
          INSTRUCTION: ${{ steps.review-context.outputs.instruction }}
          PR_NUMBER: ${{ steps.review-context.outputs.pr_number }}
        run: |
          node .github/scripts/rewrite.js

      - name: Commit rewrite result
        if: steps.rewrite.outputs.success == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          INSTRUCTION="${{ steps.review-context.outputs.instruction }}"
          SHORT_INSTRUCTION="${INSTRUCTION:0:30}"
          FILE="${{ steps.review-context.outputs.file_path }}"
          git commit -m "[rewrite] ${FILE##*/}: ${SHORT_INSTRUCTION}"
          git push origin ${{ steps.review-context.outputs.branch }}

      - name: Reply to review comment
        if: steps.rewrite.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('/tmp/rewrite-summary.md', 'utf-8');
            } catch {
              summary = 'ãƒªãƒ©ã‚¤ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            }
            // Reply to the review comment
            await github.rest.pulls.createReplyForReviewComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              comment_id: context.payload.comment.id,
              body: `âœ… ãƒªãƒ©ã‚¤ãƒˆå®Œäº†\n\n${summary}`,
            });

      - name: Reply on error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReplyForReviewComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              comment_id: context.payload.comment.id,
              body: 'âŒ ãƒªãƒ©ã‚¤ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆã« `/rewrite [æŒ‡ç¤ºå†…å®¹]` ã®å½¢å¼ã§è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚',
            });
